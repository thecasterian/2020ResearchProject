\documentclass[a4paper, 10pt]{article}

\usepackage{kotex}
\usepackage{amsmath}

\usepackage{geometry}
\geometry{margin=1in}

\renewcommand{\Re}{\mathrm{Re}}
\newcommand{\RHS}{\mathrm{RHS}}

\begin{document}

\begin{equation} \label{eq:substep}
    \frac{u_i^* - u_i^n}{\Delta t} + \frac{1}{2} [3N_i^n - N_i^{n-1}]
    = -\frac{\delta p^n}{\delta x_i} + \frac{1}{2\Re} \left( \frac{\delta^2}{\delta x^2} + \frac{\delta^2}{\delta y^2} \right) (u_i^* + u_i^n)
\end{equation}
여기서
\begin{equation}
    N_i = \frac{\delta (U_j u_i)}{\delta x_j}
\end{equation}

$N_1$과 $N_2$를 풀어쓰면
\begin{align}
    N_{1,P} &= \frac{\delta (U_1 u_1)}{\delta x} + \frac{\delta (U_2 u_1)}{\delta y}
    = \frac{U_{1,e}u_{1,e} - U_{1,w}u_{1,w}}{dx_P} + \frac{U_{2,n}u_{1,n} - U_{2,s}u_{1,s}}{dy_P} \\
    N_{2,P} &= \frac{\delta (U_1 u_2)}{\delta x} + \frac{\delta (U_2 u_2)}{\delta y}
    = \frac{U_{1,e}u_{2,e} - U_{1,w}u_{2,w}}{dx_P} + \frac{U_{2,n}u_{2,n} - U_{2,s}u_{2,s}}{dy_P}
\end{align}
여기서
\begin{subequations}
\begin{align}
    u_{i,e} &= \frac{u_{i,P}dx_E + u_{i,E}dx_P}{dx_P + dx_E} \\
    u_{i,w} &= \frac{u_{i,W}dx_P + u_{i,P}dx_W}{dx_W + dx_P} \\
    u_{i,n} &= \frac{u_{i,P}dy_N + u_{i,N}dy_P}{dy_P + dy_N} \\
    u_{i,s} &= \frac{u_{i,S}dy_P + u_{i,P}dy_S}{dy_S + dy_P}
\end{align}
\end{subequations}
이에 따라 $N_i$를 구할 수 있다.

이제 식 \eqref{eq:substep}\를 $u_i^*$에 대해 정리하자.
\begin{equation}
    \left( 1 - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta x^2} - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta y^2} \right) (u_i^* - u_i^n)
    = -\frac{\Delta t}{2}(3N_i^n - N_i^{n-1}) - \Delta t \frac{\partial p^n}{\delta x_i}
    + \frac{\Delta t}{\Re} \left( \frac{\delta^2}{\delta x^2} + \frac{\delta^2}{\delta y^2} \right) u_i^n
\end{equation}
$u_i^* - u_i^n = \bar{u}_i$로 정의하고 위 식의 좌변을 다음과 같이 근사하자.
\begin{equation}
    \left( 1 - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta x^2} \right)
    \left( 1 - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta y^2} \right) \bar{u}_i
    = -\frac{\Delta t}{2}(3N_i^n - N_i^{n-1}) - \Delta t \frac{\partial p^n}{\delta x_i}
    + \frac{\Delta t}{\Re} \left( \frac{\delta^2}{\delta x^2} + \frac{\delta^2}{\delta y^2} \right) u_i^n
\end{equation}
우변을 $\RHS_i$라 하고 $[1 - (\Delta t/2\Re)(\delta^2/\delta y^2)]\bar{u}_i = C_i$라 하면 $C_i$에 대한 삼중대각 시스템을 얻는다.
\begin{equation}
    \left( 1 - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta x^2} \right) C_i = \RHS_i
\end{equation}
풀어쓰면
\begin{equation}
    -kx_W C_{i, W} + kx_P C_{i, P} - kx_E C_{i, E} = \RHS_{i, P}
\end{equation}
여기서
\begin{equation}
    kx_W = \frac{\Delta t}{2\Re} \frac{1}{(xc_P-xc_W)dx_P}, \quad kx_E = \frac{\Delta t}{2\Re} \frac{1}{(xc_E-xc_P)dx_P}, \quad kx_P = kx_W + kx_E + 1
\end{equation}
왼쪽과 오른쪽 경계에서 $u_i$가 주어지는 경우 $\bar{u}_i$의 경계 조건은 $\bar{u}_i=0$이므로 왼쪽 경계에서는 $C_{i, W} = -C_{i, P}$이고
오른쪽 경계에서는 $C_{i, E} = -C_{i, P}$이다. 따라서 삼중대각 시스템은 다음과 같다.
\begin{multline}
    \begin{bmatrix}
        kx_W(1) + kx_P(1) & -kx_E(1) & & \\
        -kx_W(2) & kx_P(2) & -kx_E(2) & \\
        & & \ddots & \\
        & & -kx_W(N_x) & kx_P(N_x) + kx_E(N_x)
    \end{bmatrix}
    \begin{bmatrix}
        C_i(1, j) \\
        C_i(2, j) \\
        \vdots \\
        C_i(N_x, j)
    \end{bmatrix} \\
    =
    \begin{bmatrix}
        \RHS_i(1, j) \\
        \RHS_i(2, j) \\
        \vdots \\
        \RHS_i(N_x, j)
    \end{bmatrix}
\end{multline}

$C_i$를 구했으므로 $\bar{u}_i$를 구한다.
\begin{equation}
    \left( 1 - \frac{\Delta t}{2\Re} \frac{\delta^2}{\delta y^2} \right) \bar{u}_i = C_i \\
\end{equation}
또는
\begin{equation}
    -ky_S \bar{u}_{i, S} + ky_P \bar{u}_{i, P} - ky_N \bar{u}_{i, N} = C_{i, P}
\end{equation}
여기서
\begin{equation}
    ky_S = \frac{\Delta t}{2\Re} \frac{1}{(yc_P-yc_S)dy_P}, \quad kx_N = \frac{\Delta t}{2\Re} \frac{1}{(yc_N-yc_P)dy_P}, \quad ky_P = ky_W + ky_E + 1
\end{equation}
이에 따른 삼중대각 시스템은
\begin{equation}
    \begin{bmatrix}
        ky_S(1) + ky_P(1) & -ky_N(1) & & \\
        -ky_S(2) & ky_P(2) & -ky_N(2) & \\
        & & \ddots & \\
        & & -ky_S(N_y) & ky_P(N_y) + ky_N(N_y)
    \end{bmatrix}
    \begin{bmatrix}
        \bar{u}_i(i, 1) \\
        \bar{u}_i(i, 2) \\
        \vdots \\
        \bar{u}_i(i, N_y)
    \end{bmatrix}
    =
    \begin{bmatrix}
        C_i(i, 1) \\
        C_i(i, 2) \\
        \vdots \\
        C_i(i, N_y)
    \end{bmatrix}
\end{equation}

그 다음 엇갈림 중간 속도를 계산해야 한다.
\begin{subequations}
    \begin{align}
        \widetilde{u}_{1, P} &= u_{1, P}^* + \Delta t \frac{p_E^n - p_W^n}{xc_E - xc_W} &
        \widetilde{u}_{2, P} &= u_{2, P}^* + \Delta t \frac{p_N^n - p_S^n}{yc_N - yc_S} \\
        \widetilde{U}_{1, e} &= \frac{\widetilde{u}_{1, P} dx_E + \widetilde{u}_{1, E} dx_P}{dx_P + dx_E} &
        \widetilde{U}_{2, n} &= \frac{\widetilde{u}_{2, P} dy_N + \widetilde{u}_{2, N} dy_P}{dy_P + dy_N} \\
        U_{1, e}^* &= \widetilde{U}_{1, e} - \Delta t \frac{p_E^n - p_P^n}{xc_E - xc_P} &
        U_{2, n}^* &= \widetilde{U}_{2, n} - \Delta t \frac{p_N^n - p_P^n}{yc_N - yc_P}
    \end{align}
\end{subequations}

이로부터 압력 수정을 구할 수 있다. 압력 수정은 푸아송 방정식의 해로 표현된다.
\begin{equation}
    \left( \frac{\delta^2}{\delta x^2} + \frac{\delta^2}{\delta y^2} \right) p'
    = \frac{1}{\Delta t} \left( \frac{\delta U_1^*}{\delta x} + \frac{\delta U_2^*}{\delta y} \right)
\end{equation}
또는
\begin{multline}
    kx_W p'_W + kx_E p'_E + ky_S p'_S + ky_N p'_N - (kx_W + kx_E + ky_S + ky_N) p'_P \\
    = \frac{1}{2\Re} \left( \frac{U_{1, e}^* - U_{1, w}^*}{dx_P} + \frac{U_{2, n}^* - U_{2, s}^*}{dy_P} \right)
    \equiv Q_P
\end{multline}

최종적으로 압력과 속도 업데이트는
\begin{subequations}
    \begin{equation}
        p_P^{n+1} = p_P^n + p'_P
    \end{equation} \vspace{-25pt}
    \begin{align}
        u_{1, P}^{n+1} &= u_{1, P}^* - \Delta t \frac{p'_E - p'_W}{xc_E - xc_W} &
        u_{2, P}^{n+1} &= u_{2, P}^* - \Delta t \frac{p'_N - p'_S}{yc_N - yc_S} \\
        U_{1, e}^{n+1} &= U_{1, e}^* - \Delta t \frac{p'_E - p'_P}{xc_E - xc_P} &
        U_{2, n}^{n+1} &= U_{2, n}^* - \Delta t \frac{p'_N - p'_P}{yc_N - yc_P}
    \end{align}
\end{subequations}


\end{document}