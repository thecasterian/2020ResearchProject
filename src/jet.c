#include <stdio.h>
#include <math.h>

#include "utils.h"
#include "geo3d.h"
#include "ibm3d.h"

#define Nx 117
#define Ny 108
#define Nz 108

#define PATH "/home/jeonukim/data/jet"

const double Re = 1000;
const double dt = 0.01;

/* Grid coordinates. */
const double xf[Nx+1] = {0, 0.03125, 0.0634375, 0.096590625, 0.13073834375, 0.1659104940625, 0.202137808884375, 0.239451943150906, 0.277885501445433, 0.317472066488796, 0.35824622848346, 0.400243615337964, 0.443500923798103, 0.488055951512046, 0.533947630057408, 0.58121605895913, 0.629902540727904, 0.680049616949741, 0.731701105458233, 0.78490213862198, 0.839699202780639, 0.896140178864059, 0.954274384229981, 1.01415261575688, 1.07582719422959, 1.13935201005647, 1.20478257035817, 1.27217604746891, 1.34159132889298, 1.41308906875977, 1.48673174082256, 1.56258369304724, 1.64071120383866, 1.72118253995382, 1.80406801615243, 1.88944005663701, 1.97737325833612, 2.0679444560862, 2.16123278976878, 2.25731977346185, 2.3562893666657, 2.45822804766568, 2.56322488909565, 2.67137163576852, 2.78276278484157, 2.89749566838682, 3.01567053843842, 3.13739065459158, 3.26276237422932, 3.3918952454562, 3.52490210281989, 3.66189916590449, 3.80300614088162, 3.94834632510807, 4.09804671486131, 4.25223811630715, 4.41105525979637, 4.57463691759026, 4.74312602511796, 4.9166698058715, 5.09541990004765, 5.27953249704908, 5.46916847196055, 5.66449352611937, 5.86567833190295, 6.07289868186004, 6.28633564231584, 6.50617571158531, 6.73261098293287, 6.96583931242086, 7.20606449179348, 7.45349642654729, 7.70835131934371, 7.97085185892402, 8.24122741469174, 8.51971423713249, 8.80655566424647, 9.10200233417386, 9.40631240419908, 9.71975177632505, 10.0425943296148, 10.3751221595032, 10.7176258242883, 11.070404599017, 11.4337667369875, 11.8080297390971, 12.19352063127, 12.5905762502081, 12.9995435377144, 13.4207798438458, 13.8546532391612, 14.301542836336, 14.7618391214261, 15.2359442950689, 15.724272623921, 16.2272508026386, 16.7453183267178, 17.2789278765193, 17.8285457128149, 18.3946520841993, 18.9777416467253, 19.5783238961271, 20.1969236130109, 20.8340813214012, 21.4903537610432, 22.1663143738745, 22.8625538050908, 23.5796804192435, 24.3183208318208, 25.0791204567754, 25.8627440704787, 26.669876392593, 27.5012226843708, 28.3575093649019, 29.239484645849, 30.1479191852245, 31.0836067607812, 32.0473649636046};
const double yf[Ny+1] = {-8.06843894300554, -7.66934661238623, -7.28925867846307, -6.92727016996483, -6.58251920949032, -6.25418496141935, -5.94148567754224, -5.64367683575451, -5.36004936738525, -5.08992796893833, -4.83266949422698, -4.58766142307332, -4.35432040292697, -4.13209085993045, -3.92044367612423, -3.71887492964213, -3.52690469489726, -3.34407589990216, -3.16995323800205, -3.00412213143053, -2.84618774421955, -2.69577404211386, -2.55252289725129, -2.41609323547742, -2.28616022426421, -2.16241449929925, -2.04456142790404, -1.93232040752766, -1.82542419764539, -1.7236182834718, -1.62666026997314, -1.53431930473633, -1.44637552832031, -1.36261955078125, -1.282851953125, -1.2068828125, -1.13453125, -1.065625, -1, -0.9375, -0.875, -0.8125, -0.75, -0.6875, -0.625, -0.5625, -0.5, -0.4375, -0.375, -0.3125, -0.25, -0.1875, -0.125, -0.0625, 0, 0.0625, 0.125, 0.1875, 0.25, 0.3125, 0.375, 0.4375, 0.5, 0.5625, 0.625, 0.6875, 0.75, 0.8125, 0.875, 0.9375, 1, 1.065625, 1.13453125, 1.2068828125, 1.282851953125, 1.36261955078125, 1.44637552832031, 1.53431930473633, 1.62666026997314, 1.7236182834718, 1.82542419764539, 1.93232040752766, 2.04456142790404, 2.16241449929925, 2.28616022426421, 2.41609323547742, 2.55252289725129, 2.69577404211386, 2.84618774421955, 3.00412213143053, 3.16995323800205, 3.34407589990216, 3.52690469489726, 3.71887492964213, 3.92044367612423, 4.13209085993045, 4.35432040292697, 4.58766142307332, 4.83266949422698, 5.08992796893833, 5.36004936738525, 5.64367683575451, 5.94148567754224, 6.25418496141935, 6.58251920949032, 6.92727016996483, 7.28925867846307, 7.66934661238623, 8.06843894300554};
const double zf[Nz+1] = {-8.06843894300554, -7.66934661238623, -7.28925867846307, -6.92727016996483, -6.58251920949032, -6.25418496141935, -5.94148567754224, -5.64367683575451, -5.36004936738525, -5.08992796893833, -4.83266949422698, -4.58766142307332, -4.35432040292697, -4.13209085993045, -3.92044367612423, -3.71887492964213, -3.52690469489726, -3.34407589990216, -3.16995323800205, -3.00412213143053, -2.84618774421955, -2.69577404211386, -2.55252289725129, -2.41609323547742, -2.28616022426421, -2.16241449929925, -2.04456142790404, -1.93232040752766, -1.82542419764539, -1.7236182834718, -1.62666026997314, -1.53431930473633, -1.44637552832031, -1.36261955078125, -1.282851953125, -1.2068828125, -1.13453125, -1.065625, -1, -0.9375, -0.875, -0.8125, -0.75, -0.6875, -0.625, -0.5625, -0.5, -0.4375, -0.375, -0.3125, -0.25, -0.1875, -0.125, -0.0625, 0, 0.0625, 0.125, 0.1875, 0.25, 0.3125, 0.375, 0.4375, 0.5, 0.5625, 0.625, 0.6875, 0.75, 0.8125, 0.875, 0.9375, 1, 1.065625, 1.13453125, 1.2068828125, 1.282851953125, 1.36261955078125, 1.44637552832031, 1.53431930473633, 1.62666026997314, 1.7236182834718, 1.82542419764539, 1.93232040752766, 2.04456142790404, 2.16241449929925, 2.28616022426421, 2.41609323547742, 2.55252289725129, 2.69577404211386, 2.84618774421955, 3.00412213143053, 3.16995323800205, 3.34407589990216, 3.52690469489726, 3.71887492964213, 3.92044367612423, 4.13209085993045, 4.35432040292697, 4.58766142307332, 4.83266949422698, 5.08992796893833, 5.36004936738525, 5.64367683575451, 5.94148567754224, 6.25418496141935, 6.58251920949032, 6.92727016996483, 7.28925867846307, 7.66934661238623, 8.06843894300554};

double inlet_vel_x(double, double, double, double);
double inlet_vel_y(double, double, double, double);
double inlet_vel_z(double, double, double, double);

int main(int argc, char **argv) {
    /* Number of all processes. */
    int num_process;
    /* Rank of current process. */
    int rank;
    /* IBM solver. */
    IBMSolver *solver;

    /* Initialize. */
    MPI_Init(&argc, &argv);
    MPI_Comm_size(MPI_COMM_WORLD, &num_process);
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);

    HYPRE_Init();

    if (rank == 0) {
        printf("Run with %d processes\n", num_process);
    }

    /* Set solver. */
    solver = IBMSolver_new(num_process, rank, 4, 2, 2);

    IBMSolver_set_grid(solver, Nx, Ny, Nz, xf, yf, zf);
    IBMSolver_set_params(solver, Re, dt);

    IBMSolver_set_bc(solver, DIR_WEST, BC_VELOCITY_COMPONENT, VAL_FUNC, inlet_vel_x, inlet_vel_y, inlet_vel_z);
    IBMSolver_set_bc(solver, DIR_EAST | DIR_SOUTH | DIR_NORTH | DIR_DOWN | DIR_UP, BC_PRESSURE, VAL_CONST, 0.);

    IBMSolver_set_obstacle(solver, NULL);

    IBMSolver_set_linear_solver(solver, SOLVER_BiCGSTAB, PRECOND_AMG, 1e-6);

    IBMSolver_set_autosave(solver, PATH "/jet", 0);

    IBMSolver_assemble(solver);

    /* Print statistics and problem info. */
    if (rank == 1) {
        /* Mesh statistics */
        printf("\n");
        printf("Input mesh size: %d x %d x %d\n", Nx, Ny, Nz);
        printf("  xmin: %10.4lf, xmax: %10.4lf\n", xf[0], xf[Nx]);
        printf("  ymin: %10.4lf, ymax: %10.4lf\n", yf[0], yf[Ny]);
        printf("  zmin: %10.4lf, zmax: %10.4lf\n", zf[0], zf[Nz]);

        /* Reynolds number and delta t */
        printf("\n");
        printf("Reynolds no.: %.6lf\n", Re);
        printf("delta t     : %.6lf\n", dt);
    }

    /* Initialize. */
    if (1) {
        IBMSolver_init_flow_const(solver, 0, 0, 0, 0);
    }
    else {
        IBMSolver_init_flow_file(solver, PATH "/jet-01000");
    }

    /* Iterate. */
    IBMSolver_iterate(solver, 100, true);

    /* Export result. */
    IBMSolver_export_result(solver, PATH "/jet");

    /* Finalize. */
    IBMSolver_destroy(solver);

    HYPRE_Finalize();
    MPI_Finalize();

    return 0;
}

double inlet_vel_x(double t UNUSED, double x UNUSED, double y, double z) {
    return sqrt(y*y + z*z) < 0.5 ? 1 : 0;
}

double inlet_vel_y(double t UNUSED, double x UNUSED, double y UNUSED, double z UNUSED) {
    return 0;
}

double inlet_vel_z(double t UNUSED, double x UNUSED, double y UNUSED, double z UNUSED) {
    return 0;
}
